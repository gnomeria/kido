---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Add Child - Kido">
  <div class="min-h-screen bg-base-200 py-8">
    <div class="container mx-auto px-4 max-w-lg">
      <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
          <h2 class="card-title text-2xl mb-6">Add New Child</h2>
          
          <form id="child-form" class="space-y-4">
            <!-- Child Name -->
            <div class="form-control">
              <label class="label">
                <span class="label-text">Child's Name *</span>
              </label>
              <input 
                type="text" 
                name="childName" 
                placeholder="Enter child's name" 
                class="input input-bordered w-full" 
                required 
              />
            </div>

            <!-- Date of Birth -->
            <div class="form-control">
              <label class="label">
                <span class="label-text">Date of Birth *</span>
              </label>
              <input 
                type="date" 
                name="dateOfBirth" 
                class="input input-bordered w-full" 
                required 
              />
            </div>

            <!-- Sex -->
            <div class="form-control">
              <label class="label">
                <span class="label-text">Sex *</span>
              </label>
              <select name="sex" class="select select-bordered w-full" required>
                <option disabled selected>Select sex</option>
                <option value="male">Male</option>
                <option value="female">Female</option>
              </select>
            </div>

            <!-- Notes -->
            <div class="form-control">
              <label class="label">
                <span class="label-text">Notes (optional)</span>
              </label>
              <textarea 
                name="notes" 
                placeholder="Any additional information about your child..." 
                class="textarea textarea-bordered w-full"
                rows="3"
              ></textarea>
            </div>

            <!-- Submit Button -->
            <div class="form-control mt-6">
              <button type="submit" class="btn btn-primary btn-lg w-full">
                Add Child
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Navigation -->
      <div class="mt-6 text-center">
        <a href="/" class="btn btn-outline">‚Üê Back to Home</a>
        <a href="/dashboard" class="btn btn-outline ml-2">View Dashboard</a>
      </div>
    </div>
  </div>

  <!-- Success Modal -->
  <div id="success-modal" class="modal">
    <div class="modal-box">
      <h3 class="font-bold text-lg">Child Added Successfully!</h3>
      <p class="py-4" id="success-message">Child has been added to your family.</p>
      <div class="modal-action">
        <button class="btn btn-primary" onclick="goToDashboard()">View Dashboard</button>
        <button class="btn btn-outline" onclick="addMeasurement()">Add Measurement</button>
      </div>
    </div>
  </div>
</Layout>

<script>
  // Types
  interface Child {
    id: string;
    name: string;
    dateOfBirth: string;
    sex: 'male' | 'female';
    notes: string;
    createdAt: string;
  }

  // Load children from localStorage
  let children: Child[] = JSON.parse(localStorage.getItem('kido-children') || '[]');
  let lastAddedChildId = '';

  document.addEventListener('DOMContentLoaded', function() {
    // Form submission handler
    const form = document.getElementById('child-form') as HTMLFormElement;
    if (form) {
      form.addEventListener('submit', handleFormSubmit);
    }
  });

  function handleFormSubmit(event: Event) {
    event.preventDefault();
    
    const form = event.target as HTMLFormElement;
    const formData = new FormData(form);
    
    // Check if child name already exists
    const childName = formData.get('childName') as string;
    if (children.some(child => child.name.toLowerCase() === childName.toLowerCase())) {
      alert('A child with this name already exists. Please use a different name.');
      return;
    }
    
    // Create child object
    const child: Child = {
      id: Date.now().toString(),
      name: childName,
      dateOfBirth: formData.get('dateOfBirth') as string,
      sex: formData.get('sex') as 'male' | 'female',
      notes: formData.get('notes') as string || '',
      createdAt: new Date().toISOString()
    };
    
    // Save to memory/localStorage
    children.push(child);
    localStorage.setItem('kido-children', JSON.stringify(children));
    lastAddedChildId = child.id;
    
    // Show success modal
    showSuccessModal(child.name);
    
    // Reset form
    form.reset();
  }

  function showSuccessModal(childName: string) {
    const modal = document.getElementById('success-modal') as HTMLElement;
    const message = document.getElementById('success-message') as HTMLElement;
    
    if (modal && message) {
      message.textContent = `${childName} has been added to your family successfully!`;
      modal.classList.add('modal-open');
    }
  }

  function goToDashboard() {
    window.location.href = '/dashboard';
  }

  function addMeasurement() {
    // Store the selected child ID for the measurement form
    if (lastAddedChildId) {
      localStorage.setItem('kido-selected-child', lastAddedChildId);
    }
    window.location.href = '/add-measurement';
  }

  // Make functions globally available
  (window as any).goToDashboard = goToDashboard;
  (window as any).addMeasurement = addMeasurement;
</script>